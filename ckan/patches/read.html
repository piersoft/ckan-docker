{% extends "package/read_base.html" %}

{% block primary_content_inner %}
  {{ super() }}
  {% block package_description %}
    {% if pkg.private %}
      <span class="dataset-private badge badge-inverse pull-right">
        <i class="fa fa-lock"></i>
        {{ _('Private') }}
      </span>
    {% endif %}
    <h1>
      {% block page_heading %}
        {{ h.dataset_display_name(pkg) }}
        {% if pkg.state.startswith('draft') %}
          [{{ _('Draft') }}]
        {% endif %}
        {% if pkg.state == 'deleted' %}
          [{{ _('Deleted') }}]
        {% endif %}
      {% endblock %}
    </h1>
    {% block package_notes %}
      {% if pkg.notes %}
        <div class="notes embedded-content">
          {{ h.render_markdown(h.get_translated(pkg, 'notes')) }}
        </div>
      {% endif %}
    {% endblock %}
  {% endblock %}

  {% block package_resources %}
    {% snippet "package/snippets/resources_list.html", pkg=pkg, resources=pkg.resources,
      can_edit=h.check_access('package_update', {'id':pkg.id }) %}
{# Container per mostrare la quality measure dall'API GAL --- #}
<div id="quality_meas_container" style="margin:1em 0; padding:0.5em; border:1px solid #ccc; background:#f9f9f9;">
  <strong>
    <a href="https://data.europa.eu/mqa/methodology?locale=it" target="_blank" style="text-decoration:none; color:#0066cc;">
      Punteggio qualità dal portale europeo <span title="Scopri la metodologia">ℹ️</span>
    </a>:
  </strong>
  <span class="qm-value">Caricamento…</span>
</div>
  {% endblock %}

  {% block package_tags %}
    {% snippet "package/snippets/tags.html", tags=pkg.tags %}
  {% endblock %}

  {% block package_additional_info %}
    {% snippet "package/snippets/additional_info.html", pkg_dict=pkg %}
  {% endblock %}

{% block scripts %}
  {{ super() }}
<script>
(function(){
  "use strict";

  function getDatasetNameFromURL() {
    const parts = window.location.pathname.split("/");
    return parts[2] || null;  // /dataset/<name>
  }

  // ----------------------
  // 2️⃣ Legge SOLO il dct:identifier del BLOCCO dcat:Dataset dal TTL
  //    - trova il subject con "a dcat:Dataset" (o dcatapit:Dataset)
  //    - legge fino al "." di chiusura di quel subject
  // ----------------------
  async function getIdentifierFromTTL() {
    try {
      const datasetName = getDatasetNameFromURL();
      if (!datasetName) return null;

      const ttlUrl = "/dataset/" + datasetName + ".ttl";
      console.log("Carico TTL:", ttlUrl);

      const ttl = await fetch(ttlUrl).then(r => r.text());
      const lines = ttl.split("\n");

      let inDatasetBlock = false;
      const blockLines = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();

        // skip commenti e vuote
        if (!trimmed || trimmed.startsWith("#")) continue;

        if (!inDatasetBlock) {
          // Inizio blocco dataset: "<...> a ... dcat:Dataset ... ;"
          // (può contenere anche dcatapit:Dataset)
          const startMatch = line.match(/^\s*<[^>]+>\s+a\s+.*\b(dcat:Dataset|dcatapit:Dataset)\b.*[;.]?\s*$/);
          if (startMatch) {
            inDatasetBlock = true;
            blockLines.push(line);

            // Caso raro: soggetto chiuso sulla stessa riga con "."
            if (/\.\s*$/.test(line)) break;
          }
          continue;
        }

        // Dentro blocco dataset: accumula fino al punto finale "."
        blockLines.push(line);
        if (/\.\s*$/.test(line)) {
          break;
        }
      }

      if (!inDatasetBlock || blockLines.length === 0) {
        console.warn("Blocco dcat:Dataset non trovato nel TTL");
        return null;
      }

      // Cerca dct:identifier SOLO nel blocco dataset
      for (let line of blockLines) {
        const match = line.match(/^\s*dct:identifier\s+"([^"]+)"\s*[;.]?\s*$/);
        if (match) {
          const raw = match[1].trim();
          if (!raw || raw === "None") continue;

          const identifier = raw
            .replace(/[:.]/g, "-")
            .replace(/-+/g, "-")
            .replace(/^-+|-+$/g, "");

          console.log("Identifier estratto dal blocco Dataset e normalizzato:", identifier);
          return identifier;
        }
      }

      console.warn("dct:identifier non trovato dentro il blocco Dataset");
      return null;

    } catch (err) {
      console.error("Errore lettura TTL:", err);
      return null;
    }
  }

  // ----------------------
  // 3️⃣ Chiamata API qualità EU
  // ----------------------
  function updateQuality(identifier) {
    const elem = document.querySelector("#quality_meas_container .qm-value");
    if (!elem || !identifier) return;

    const apiUrl =
      "https://data.europa.eu/api/hub/search/search" +
      "?filters=dataset" +
      "&field=quality_meas" +
      "&q=" + encodeURIComponent('"' + identifier + '"');

    fetch(apiUrl)
      .then(resp => resp.json())
      .then(data => {
        const qm = data?.result?.results?.[0]?.quality_meas?.scoring;

        if (qm !== undefined) {
          let label = "";
          let color = "black";

          if (qm >= 351) { color = "green"; label = "Eccellente"; }
          else if (qm >= 221) { color = "goldenrod"; label = "Buono"; }
          else if (qm >= 121) { color = "red"; label = "Sufficiente"; }
          else { color = "red"; label = "Scarso"; }

          elem.innerHTML =
            `<span style="color:${color}; font-weight:bold;">${qm} (${label})</span>`;
        } else {
          elem.textContent = "non ancora censito";
        }
      })
      .catch(err => {
        console.error("Errore API qualità:", err);
        elem.textContent = "Errore API";
      });
  }

  async function init() {
    const identifier = await getIdentifierFromTTL();

    if (identifier) {
      updateQuality(identifier);
    } else {
      const elem = document.querySelector("#quality_meas_container .qm-value");
      if (elem) elem.textContent = "Identifier non disponibile nel TTL";
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

})();
</script>


{% endblock %}

{% endblock %}
